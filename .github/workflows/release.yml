name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            target: 'aarch64-apple-darwin'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            target: 'x86_64-apple-darwin'
          - platform: 'ubuntu-22.04'
            args: ''
            target: ''
          - platform: 'windows-latest'
            args: ''
            target: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev

      - name: Install Rosetta 2 (macOS x86_64 only)
        if: matrix.platform == 'macos-latest' && matrix.target == 'x86_64-apple-darwin'
        run: |
          softwareupdate -i "Rosetta 2" --agree-to-license

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Kyosho Backup ${{ github.ref_name }}'
          releaseBody: |
            # Kyosho Backup ${{ github.ref_name }}

            エックスサーバー専用のバックアップ自動化デスクトップアプリケーション

            ## 📥 ダウンロード

            お使いのOSに合わせてダウンロードしてください。

            ### Windows
            - `.msi`（推奨）または `-setup.exe` をダウンロード

            ### macOS
            - `.dmg` をダウンロード
              - **Intel Mac**（2020年以前）: `x64.dmg`
              - **Apple Silicon**（M1/M2/M3）: `aarch64.dmg`

            ### Linux
            - **Ubuntu/Debian**: `.deb`（推奨）
            - **すべてのLinux**: `.AppImage`（インストール不要）

            ---

            ## 🚀 主な機能

            - エックスサーバー専用設計（SSH公開鍵認証）
            - ワンクリックで簡単バックアップ
            - ドメイン自動探索機能
            - 高速ファイル転送
            - リアルタイム進捗表示

            ---

            ## 📖 使い方

            1. **SSH秘密鍵を選択** - エックスサーバーで登録した公開鍵に対応する秘密鍵ファイルを選択
            2. **接続テスト** - サーバーへの接続を確認
            3. **ドメイン探索** - サーバー上のドメインを自動検出
            4. **バックアップ元を選択** - バックアップしたいドメインをクリック
            5. **保存先を選択** - ローカルの保存先フォルダを指定
            6. **バックアップ開始** - ボタンをクリックして実行

            ---

            ## ⚠️ 動作環境

            - **Windows**: Windows 10 (64bit) 以降
            - **macOS**: macOS 11 Big Sur以降
            - **Linux**: Ubuntu 20.04以降 / Debian 11以降

            ---

            ## 🔒 セキュリティ

            - SSH公開鍵認証のみサポート
            - すべての通信はSSH暗号化
            - 認証情報はローカルマシンにのみ保存

            ---

            問題が発生した場合は [Issues](https://github.com/yutamatsuura/kyosho-backup/issues) でご報告ください。
          releaseDraft: false
          prerelease: false
          args: ${{ matrix.args }}
